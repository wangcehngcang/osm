<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
    <title>首页</title>
	<link rel="stylesheet" href="stylesheets/index.css">
	<link rel="stylesheet" href="font_ps99atp86ak/iconfont.css">
    <link rel="icon" href="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=427901597,3540167180&fm=26&gp=0.jpg">
	<link rel="icon" href="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=427901597,3540167180&fm=26&gp=0.jpg">
	<link rel="stylesheet" href="font/iconfont.css">
	<style>
		#mask{
			width:100%;
			position: fixed;
			left:0;
            bottom:0;
            text-align: center;
            font-size: 40px;
            display: none;
            line-height: 300px;
        }
        #mask a{
            text-decoration: underline;
            color:red;
        }
	</style>
</head>
<body>
	<div id="mask">
        请先登录账号↓
        <a class="go" href="login.html">注册或登录</a>
    </div>
	
    <div id="box">

        <div class="header">
            <img src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=427901597,3540167180&fm=26&gp=0.jpg" alt="">
            <span>学生管理系统</span>
            <a class="go" href="login.html">注册或登录</a>
            <a class="out iconfont" href="#" style="font-size:20px;">&#xe6dd;</a>
            <p id="user">
                <span class="iconfont">&#xe511;</span> : <i>未登录</i>
            </p>
        </div>
        <div id="content" class="clearfix">
            <div id="left">
                 <ul>
                    <li class="active"><a href="index.html"><i class="iconfont">&#xe602;</i> 首页</a></li>
                    <li><a href="record.html"><i class="iconfont">&#xe513;</i> 新增学生</a></li>
                    <li><a href="class.html"><i class="iconfont">&#xe686;</i> 班级</a></li>
                    <li><a href="lecturer.html"><i class="iconfont">&#xe601;</i> 讲师</a></li>
                    <li><a href="curriculum.html"><i class="iconfont">&#xe506;</i> 课程</a></li>
                    <li id="student">
                        <a href="javascript:;">
                        <i class="iconfont">&#xe513;</i> 学生</a>
                        <ul id="enl">
                            <li><a href="student.html"><i class="iconfont">&#xe603;</i> 基本信息</a></li>
                            <li><a href="state.html"><i class="iconfont">&#xe61e;</i> 当前状态</a></li>
                			<li><a href="achievement.html"><i class="iconfont">&#xe63d;</i> 成绩录入</a></li>
                            <li><a href="guanli.html"><i class="iconfont">&#xe76a;</i> 综合积分</a></li>
                			<li><a href="http://z.cimns.com:8081/"><i class="iconfont">&#xe65e;</i> 作业上传</a></li>
                            <li><a href="fankui.html"><i class="iconfont">&#xe608;</i> 学生反馈</a></li>
                        </ul>
                    </li>
                    <li><a href="sushe.html"><i class="iconfont">&#xe504;</i> 宿舍</a></li>
                    <li><a href="guanli.html"><i class="iconfont">&#xe64a;</i> 综合积分</a></li>
                </ul>
                </ul>
            </div>
            <div id="right">
				<p class="classification"><span></span>&nbsp;&nbsp;&nbsp;各个班级情况</p>
                <table id="table" border="0" style="border: 2px solid #2CC9AA;" cellspacing="0">
                    <thead>
						<tr>
						    <th>各阶段</th>
						    <th>在校人数</th>
						    <th>休学人数</th>
						    <th>退学人数</th>
						    <th>末班人数</th>
						    <th>本月成材率</th>
						    <th>本周违纪人数</th>
						    <th>上周违纪人数</th>
						    <th>违纪类型细分</th>
						</tr>
					</thead>
					<tbody id="iall">
						
					</tbody>
                </table>
            </div>
        </div>
        <div id="footer">
            <p>学生管理委员会</p>
            <p>学校学生工作汇报</p>
            <ul>
                <li>开发人员</li>
                <li>帮助中心</li>
                <li>关于我们</li>
                <li>在线留言</li>
                <li>联系我们</li>
            </ul>
            <p>@Copyright by htly 2000-2019 公司：系统管理应用有限公司 地址：北京市中关村</p>
        </div>
    </div>
	<script src="font/iconfont.js"></script>
	<script src="font_ps99atp86ak/iconfont.js"></script>
    <script src="js/jquery.js"></script>
    <script>
		//提示鼠标所在导航条
		var oli=document.querySelectorAll('#left>ul>li');
		var ali=document.querySelectorAll('#enl>li');
		for(var i=0;i<oli.length;i++){
			oli[i].index=i;
			oli[i].onclick=function(){
				for(var i=0;i<oli.length;i++){
					oli[i].className=''
				}
				oli[this.index].className='active'
			}
		}
		for(var i=0;i<ali.length;i++){
			ali[i].index=i;
			ali[i].onclick=function(){
				for(var i=0;i<ali.length;i++){
					ali[i].className=''
				}
				ali[this.index].className='active'
			}
		}
		
		//学生下拉框增加高度
        $('#student a').on('click',function(){
            if($('#student ul').css("height")=="0px"){
                $('#student ul').css({
                    // display:'block',
                    "height":"360px",
                    transition:'1s',
                })
            }else{
                $('#student ul').css({
                    // display:'none',
                    "height":"0",
                    transition:'1s',
                })           
            }
        })
		
		//未登录是遮罩层
		var audi='';
		var h=$(document).height()-60;
		// console.log(h)
		mask.style.height=h+'px';
        if(localStorage.user){
            $('.go').css({
                display:'none',
            });
            $('.out').css({
                display:'block'
            });
            var localStorageUser=JSON.parse(localStorage.user);
			audi=localStorageUser.uid;
            // console.log(localStorageUser)
            $('#user i').html(localStorageUser.name)
        }else{
            $('.go').css({
                display:'block'
            });
			$('#mask').css({
			    display:'block'
			});
            $('.out').css({
                display:'none'
            });
			 $('#box').css({
			    display:'none'
			});
        }
		//退出
        $('.out').on('click',function(){
            var a=confirm('欢迎下次再来')
            if(a){
                localStorage.clear();
                location.href='./login.html'
            }
        })
		//判断改用户是否是管理员
		// console.log(audi)
		window.onload=function (){
			$.ajax({
				type:'get',
				url:'http://localhost:8000/indexs/state',
				data:{
					uid:audi,
				},
				success(data){
					console.log(data)
					if(data[0].AR=='yes'){
						console.log('管理者你好')
					}else{
						console.log('读者你好')
					}
				}
			})
        }
        var href = 'http://localhost:8000';
        $.ajax({
            type:'get',
            async:false,
            url:href+'/state/getL',
            success(res){
                var xiuxue = [];
                var tuixue = [];
                for(var i=0;i<res.length;i++){
                    // console.log(res[i])
                    //休学
                    if(res[i].ora == 'true'){
                        xiuxue.push(res[i].classa);
                    }				
                    //退学
                    if(res[i].resona == '退学'){
                        tuixue.push(res[i].classa);
                    }
                    
                }
                //休学
                objs = {};
                for (var i = 0, l = xiuxue.length; i < l; i++) {
                    var item = xiuxue[i];
                    objs[item] = (objs[item] + 1) || 1;
                }
                // console.log(objs);
                //退学
                tx = {};
                for (var i = 0, l = tuixue.length; i < l; i++) {
                    var item = tuixue[i];
                    tx[item] = (tx[item] + 1) || 1;
                }
                // console.log(tx);
                
            }
        })
        //末班
        $.ajax ({
            type:'get',
            async:false,
            url:href+'/indexs/reads',
            success(data){
                var moban=[];
                var arr=[];
                var reason = [];
                for(var i=0;i<data.length;i++){
                    // console.log(data);
                    //末班
                    if(data[i].adopt == '否'){
                        moban.push(data[i].class)
                    }				
                }
                //末班
                mb = {};
                for (var i = 0, l = moban.length; i < l; i++) {
                    var item = moban[i];
                    mb[item] = (mb[item] + 1) || 1;
                }
                // console.log(mb);
                
            }
        })
        
        //违纪人数和原因
        $.ajax({
            type: 'get',
            async:false,
            url: href+'/indexs/read',
            success(data) {
                var weiji=[];
                reason = [];
                for (var i = 0; i < data.length; i++) {
                    // console.log(data[i]);
                    weiji.push(data[i].bj);
                    reason.push(data[i].Reason);
                }
                wj = {};
                for (var i = 0, l = weiji.length; i < l; i++) {
                    var item = weiji[i];
                    wj[item] = (wj[item] + 1) || 1;
                }
                // console.log(wj);
                // console.log(reason);
            }
            
        })
        //违纪原因去重
        var reasons=[];
        reason.forEach(function(item){
            if(reasons.indexOf(item)==-1){
                reasons.push(item);
            }
        });



        read();
        
        //读取班级信息
        function read() {
            $.ajax({
                type: 'get',
                url: href + '/banji/read',
                async: false,
                success(data) {
					var str=``
                    for (var i = 0; i < data.length; i++) {
                        str+= `
							<tr>
								<td>${data[i].class}(${data[i].stage})</td>
								<td>${data[i].number}</td>
								<td>${(objs[data[i].class] || 0)}</td>
								<td>${(tx[data[i].class] || 0)}</td>
								<td>${(mb[data[i].class] || 0)}</td>
								<td>${((data[i].number - (objs[data[i].class] || 0) - (tx[data[i].class] || 0) - (mb[data[i].class] || 0)) / (data[i].number - (objs[data[i].class] || 0) - (tx[data[i].class] || 0)) * 100).toFixed(2) + '%'}</td>
								<td>${(wj[data[i].class] || 0)}</td>
								<td>${(wj[data[i].class] || 0)}</td>
								<td>${reasons}</td>
							</tr>
                        `;
                    }
					iall.innerHTML=str
                }
            })
        }
        
        
    </script>
</body>
</html>